# Design

According to [Enclave Confidential Containers (Enclave-CC) Design and Architecture](./design.md),
shim-rune should launch the agent enclave container when pod creation. The agent enclave container
is deployed in the form of OCI bundle (pre-installed on each node) rather than a container image,
and thus `shim-rune` can call `rune` to start it. The agent enclave container has the same life
cycle as the pod. Its main job is to receive and then load the actual workload's container image
into an app enclave.

![image](./images/shim.png)

As is shown in the picture, the binary name of `shim-rune` is `containerd-shim-rune-v2`.
`shim-rune` should implement the Containerd Runtime V2 (Shim API) for Enclave-CC. With `shim-rune`,
Kubernetes can launch Pod and OCI-compatible containers with one shim per Pod.

## Goals

- Implements [Containerd Runtime V2 (Shim API)](https://github.com/containerd/containerd/tree/main/runtime/v2)
- Use `rune` OCI runtime to manage container
- Launch agent enclave container during PodSandbox creation
- Complete PullImage with agent enclave container with ttrpc communication
- Launch application enclave container with FUSE encryption filesystem generated by agent enclave
container.
- Kill and cleanup agent enclave container resource when stopping PodSandbox

# Workflow

## 1. RunPodSandbox

Compared with `containerd-shim-runc-v2`, `shim-rune` should add the following functions when
launching the pod sandbox.

- In the `Create` API of shim-rune, shim-rune will create an agent enclave container with the
pre-installed OCI bundle after the pause container is created successfully.
- In the `Start` API of shim-rune, shim-rune will start the agent enclave container after the pause
container is started successfully.

A pre-installed OCI bundle for the agent enclave container is needed instead of the form of container
image because the agent enclave container is the first component along with pod creation and there
is no direct support for it to pull and unpack it in a TEE. The `agent_container_instance` field in
the configuration file of shim-rune(In the Appendix section) shows the host path of OCI bundle for
the agent enclave container. The contents of the bundle are as follows:

```sh
$ tree /opt/enclave-cc/agent-instance/ -L 1
/opt/enclave-cc/agent-instance/
├── config.json
└── rootfs
```

Note that OCI bundle of the agent enclave container (`agent_container_instance` field in the
shim-rune configuration file) must be **read-only** because the agent enclave containers of all
Pods on this node share this bundle. Once modified, it will affect the behavior of existing or newly
created agent enclave containers. Therefore, every time the agent enclave container is created,
`agent_container_instance` is used as the read-only layer and then overlays read and write layers
to aggregate the final OCI bundle for the agent enclave container.

In addition, the OCI bundle of agent container may have multiple different versions, they contain
different versions of untrusted PAL (even support different LibOS) and its dependencies, such as
configuration files. shim-rune just needs to call `rune` and pass the location of its OCI bundle
to rune.

`rune` receives the path of the OCI bundle passed by shim-rune, parses the OCI container
configuration file, creates and enters a new mount namespace, and uses bind mount to mount the
rootfs directory tree in the OCI bundle as the container rootfs. Finally, LibOS is loaded and
initialized through the PAL API `pal_init()` as the agent enclave container's No. 1 process runelet. Please
refer to [rune](https://github.com/inclavare-containers/inclavare-containers/tree/master/rune)
for the detail information.

## 2. Pull application image

1. The `PullImage` API of shim-rune will send `PullImageRequest` to the agent enclave container.
2. The agent enclave container uses the`image-rs` to pull images and the encrypted file system
capabilities provided by LibOS to create an encrypted unionfs (based sefs) image.
3. The agent enclave store the encrypted unionfs image in host. We will discuss the
path of encrypted unionfs image in the next subsection(Create app container section).

### Communication protocol

Below is the communication protocol between shim-rune and agent enclave container, the
communication protocol is referred to
[kata containers](https://github.com/confidential-containers/kata-containers/blob/CCv0/src/libs/protocols/protos/image.proto).

```proto
syntax = "proto3";
...
// Image defines the public APIs for managing images.
service Image {
    // PullImage pulls an image with authentication config.
    rpc PullImage(PullImageRequest) returns (PullImageResponse) {}
}

message PullImageRequest {
    // Image name (e.g. docker.io/library/busybox:latest).
    string image = 1;
    // Unique image identifier, used to avoid duplication when unpacking the image layers.
    string container_id = 2;
    // Use USERNAME[:PASSWORD] for accessing the registry
    string source_creds = 3;
}

message PullImageResponse {
    // Reference to the image in use. For most runtimes, this should be an
    // image ID or digest.
    string image_ref = 1;
}
```

## 3. Create app container

Ideally, just like `kata-agent`, the agent enclave container generates the bundle of the app
container without requiring any confidential compute dependencies in the original container image.
Unlike `kata-agent`, the agent enclave container will prepare the bundle in a way that
a LibOS can load the application inside an enclave.

But each LibOS has limited capabilities such as:

- For UnionFS supported by Occlum, the lower layer must be a single-layer FUSE encrypted file
system, and the app container image to be aggregated by agent enclave may contain multiple layers,
that is, the lower layer is not a single layer.
- Gramine may not be able to easily support the ability to aggregate filesystems.

Possible solutions:

- In the long run, promote LibOS to realize the aggregation capability of supporting multiple
lower layers.
- In the short to medium term, the enclave-agent program cannot rely on the rootfs aggregation
capability of a specific LibOS to construct the OCI bundle of the app container. shim-rune is
responsible for generating the bundle of the app container.

Considering these limitations and after discussing with Libos team, the first stage enclave-cc
uses the following methods to run the app enclave container.

### Occlum

Refer to the occlum guide of
[Runtime boot pre-generated UnionFS image](https://github.com/qzheng527/occlum/blob/combine_jsons/demos/runtime_boot).
A pre-installed OCI bundle for the boot instance is needed in the host. The boot instance is
responsible for using the customized `init`, mount and boot a pre-generated UnionFS image.

Considering the implementation of occlum dynamic mount image, shim-rune should overlay the
`boot instance bundle` and `encrypted unionfs image` to generate the final bundle of the app
container. For example:

```sh
mount -t overlay overlay -o
  lowerdir= <path of encrypted unionfs image>:<path of boot instance bundle>,
  upperdir=upper, workdir=work merged
```

Then the question is where is the location of `boot instance bundle` and `encrypted unionfs image`?

- Location of `boot instance bundle`

One host only needs a pre-installed occlum OCI bundle for the boot instance. The
`boot_container_instance` field in shim configure file can show the location.

The pre-generated boot template instance looks like an OCI bundle rootfs on the host side.
It contains the
[occlum boot template instance](https://github.com/qzheng527/occlum/blob/combine_jsons/demos/runtime_boot/README.md#build-a-boot-template-occlum-instance).

```sh
$ tree /opt/enclave-cc/boot-instance -L 1
/opt/enclave-cc/boot-instance
└── rootfs

1 directory, 1 file
```

- Location of `encrypted unionfs image`

Each pod has exactly one agent enclave container. The agent enclave container needs to manage
multiple images. After the agent container pulls an image, it will convert all layers of this
image into an encrypted unionfs (based sefs) image in the host.

Since one image corresponds to a encrypted unionfs image, shim-rune can generate `container_id`
based on image name and pass `container_id` to agent enclave container with `PullImageRequest`.
The agent enclave container can store the encrypted unionfs image to directory distinguished by
`container_id` in host, such as `<agent_container_bundle_path>/rootfs/images/<container_id>/sefs`.

When shim-rune launch the app enclave container, shim-rune will find the corresponding encrypted
unionfs image through `container_id`. Then shim-rune overlay the `encrypted unionfs image` and
`boot instance bundle` to generate the final app enclave container bundle.

### Gramine

TODO

At last, shim-rune call `rune` to launch the app enclave container. The process is similar to
launch the agent enclave container with `rune`.

## 4. Stop sandbox

Compared with `containerd-shim-runc-v2`, shim-rune adds the work of kill/cleanup for the agent
enclave container.

# How to integrate with containerd

Because shim-rune supports containerd shim v2 API, you can add the associated configurations for
shim-rune in the containerd config file, e.g, `/etc/containerd/config.toml`, on your system.

```toml
        [plugins.cri.containerd]
          ...
          [plugins.cri.containerd.runtimes.rune]
            runtime_type = "io.containerd.rune.v2"
```
then restart containerd on your system.

# Appendix

## shim configuration sample

```toml
log_level = "info" # "debug" "info" "warn" "error"

[containerd]
    socket = "/run/containerd/containerd.sock"
    agent_container_instance = "/opt/enclave-cc/agent-instance/"
    boot_container_instance = "/opt/enclave-cc/boot-instance/"
    agent_container_root_dir = "/run/containerd/agentenclave"
    agent_url = "tcp://0.0.0.0:7788"
```

where:
- @log_level: specify the log level for shim-rune.
- @socket: the containerd socket
- @agent_container_instance:  the host path of pre-installed OCI bundle for agent enclave container
- @boot_container_instance: the host path of pre-installed OCI bundle for boot instance
- @agent_container_root_dir: the root dir of agent enclave container running state
- @agent_url: the listening address of the agent container, through which the shim communicates
with the agent container to perform PullImage. (support unix and tcp socket communication)
  - Currently occlum 0.27 version does not support cross-world untrusted Unix domain socket.
  - After occlum releases [NGO](https://github.com/occlum/ngo) at June 2022, the communication
  based on tcp socket between shim-rune and agent container will be switched to ttrpc based on
  cross-world untrusted Unix domain socket.

# Reference

- [kata containers](https://github.com/confidential-containers/kata-containers-CCv0)
- [containerd](https://github.com/confidential-containers/containerd)
- [occlum](https://github.com/occlum/occlum)
- [inclavare containers](https://github.com/inclavare-containers/inclavare-containers)
